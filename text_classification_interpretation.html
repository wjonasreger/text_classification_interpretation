<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hope Hunter, Jonas Reger">
<meta name="dcterms.date" content="2022-11-28">
<meta name="description" content="Some regularized logistic models for predicting sentiments of movie reviews using interpretive words">

<title>Text Classification for Interpretation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="text_classification_interpretation_files/libs/clipboard/clipboard.min.js"></script>
<script src="text_classification_interpretation_files/libs/quarto-html/quarto.js"></script>
<script src="text_classification_interpretation_files/libs/quarto-html/popper.min.js"></script>
<script src="text_classification_interpretation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="text_classification_interpretation_files/libs/quarto-html/anchor.min.js"></script>
<link href="text_classification_interpretation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="text_classification_interpretation_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="text_classification_interpretation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="text_classification_interpretation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="text_classification_interpretation_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">

<main class="content column-page" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Text Classification for Interpretation</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button" data-quarto-source-url="https://github.com/wjonasreger/text_classification_interpretation">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">Machine Learning</div>
    <div class="quarto-category">NLP</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Statistics</div>
  </div>
  </div>

<div>
  <div class="description">
    Some regularized logistic models for predicting sentiments of movie reviews using interpretive words
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Hope Hunter, Jonas Reger </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 28, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>In this notebook, a vocabulary set of highly interpretive terms is built, which a classification model uses to predict the sentiment of a movie review. The data set consists of <a href="https://github.com/wjonasreger/data/blob/main/imdb_reviews.tsv">50,000 IMDb movie reviews</a>, where each review is labelled as positive or negative. A subset of this data set was used in a Kaggle competition: <a href="https://www.kaggle.com/c/word2vec-nlp-tutorial">Bag of Words Meets Bags of Popcorn</a>. Specifically, a classifier based on Regularized Logistic Regression (i.e., Binomial Ridge Regression) is implemented. The source code this notebook and original documentations are viewable <a href="https://github.com/wjonasreger/text_classification_interpretation">here</a> on GitHub.</p>
<section id="load-packages-data" class="level2">
<h2 class="anchored" data-anchor-id="load-packages-data">Load Packages &amp; Data</h2>
<p>First load the dataset through the URL, or download to access it locally. The following packages will be needed for text preprocessing and analysis.</p>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(text2vec)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slam)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The IMDb movie review dataset has 50,000 rows (i.e., reviews) and 4 columns:</p>
<ul>
<li><strong>Identification number</strong>: <code>id</code></li>
<li><strong>Sentiment score</strong>: <code>sentiment</code> (i.e., <code>0</code>=negative, <code>1</code>=positive)</li>
<li><strong>10-point score assigned by the reviewer</strong>: <code>score</code> (i.e., <code>1</code>-<code>4</code>=negative sentiment, <code>7</code>-<code>10</code>=positive sentiment, <code>5</code>-<code>6</code>=ignored)</li>
<li><strong>User review</strong>: <code>review</code></li>
</ul>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>data_url <span class="ot">=</span> <span class="st">"https://raw.githubusercontent.com/wjonasreger/data/main/imdb_reviews.tsv"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">read.table</span>(data_url, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>data_head <span class="ot">=</span> <span class="fu">head</span>(data)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>data_head<span class="sc">$</span>review <span class="ot">=</span> <span class="fu">sapply</span>(data_head<span class="sc">$</span>review, <span class="cf">function</span>(x) <span class="fu">paste0</span>(<span class="fu">substr</span>(x, <span class="dv">1</span>, <span class="dv">100</span>), <span class="st">'...'</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>data_head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  id sentiment score
1  1         1    10
2  2         0     2
3  3         0     4
4  4         0     2
5  5         1     7
6  6         1     8
                                                                                                   review
1 Naturally in a film who's main themes are of mortality, nostalgia, and loss of innocence it is perha...
2 This movie is a disaster within a disaster film. It is full of great action scenes, which are only m...
3 All in all, this is a movie for kids. We saw it tonight and my child loved it. At one point my kid's...
4 Afraid of the Dark left me with the impression that several different screenplays were written, all ...
5 A very accurate depiction of small time mob life filmed in New Jersey. The story, characters and scr...
6 ...as valuable as King Tut's tomb! (OK, maybe not THAT valuable, but worth hunting down if you can)....</code></pre>
</div>
</div>
</section>
<section id="preprocess-data" class="level2">
<h2 class="anchored" data-anchor-id="preprocess-data">Preprocess Data</h2>
<p>The reviews are preprocessed by removing HTML tags and other special characters, and tokenization.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove HTML tags</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>review <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">'&lt;.*?&gt;'</span>, <span class="st">' '</span>, data<span class="sc">$</span>review)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># tokenize words in reviews</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>itokens <span class="ot">=</span> <span class="fu">itoken</span>(data<span class="sc">$</span>review, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">preprocessor =</span> tolower, </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">tokenizer =</span> word_tokenizer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A vocabulary set of n-grams is built using the tokenized data, then pruned to remove tokens that are too frequent or infrequent in the data. This removes potential noise from tokens that cannot be learned from very well.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># words ignored by the vocabulary</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>stop_words <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"i"</span>, <span class="st">"me"</span>, <span class="st">"my"</span>, <span class="st">"myself"</span>, <span class="st">"we"</span>, <span class="st">"our"</span>, <span class="st">"ours"</span>, <span class="st">"ourselves"</span>, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">"you"</span>, <span class="st">"your"</span>, <span class="st">"yours"</span>, <span class="st">"their"</span>, <span class="st">"they"</span>, <span class="st">"his"</span>, <span class="st">"her"</span>, </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">"she"</span>, <span class="st">"he"</span>, <span class="st">"a"</span>, <span class="st">"an"</span>, <span class="st">"and"</span>, <span class="st">"is"</span>, <span class="st">"was"</span>, <span class="st">"are"</span>, <span class="st">"were"</span>, </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">"him"</span>, <span class="st">"himself"</span>, <span class="st">"has"</span>, <span class="st">"have"</span>, <span class="st">"it"</span>, <span class="st">"its"</span>, <span class="st">"the"</span>, <span class="st">"us"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>vocab <span class="ot">=</span> <span class="fu">create_vocabulary</span>(itokens, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">stopwords =</span> stop_words, </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">ngram =</span> <span class="fu">c</span>(1L, 4L)) <span class="co"># uses 1-4 n-grams </span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>vocab <span class="ot">=</span> <span class="fu">prune_vocabulary</span>(vocab, </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">term_count_min =</span> <span class="dv">10</span>, <span class="co"># ignores terms under 10 count</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">doc_proportion_max =</span> <span class="fl">0.5</span>, <span class="co"># ignores terms over 0.5 proportion</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">doc_proportion_min =</span> <span class="fl">0.001</span>) <span class="co"># ignores terms under 0.001 proportion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is a sample of the vocabulary <code>vocab</code>.</p>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>vocab[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(vocab), <span class="dv">5</span>), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Number of docs: 50000 
32 stopwords: i, me, my, myself, we, our ... 
ngram_min = 1; ngram_max = 4 
Vocabulary: 
           term term_count doc_count
1:       gloria        139       110
2:      despite       2686      2385
3: hilarious_in         53        53
4:      that_by        176       175
5:     who_died         95        93</code></pre>
</div>
</div>
<p>The initial vocabulary set is then converted into a Document-Term Matrix (DTM) and normalized using TermFrequency-InverseDocumentFrequency (TF-IDF). This structure is convenient for logistic regression.</p>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a custom string function towards printing a list of words for webpage</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>cat_string <span class="ot">=</span> <span class="cf">function</span>(string_list_in, <span class="at">b=</span><span class="dv">80</span>) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  string <span class="ot">=</span> <span class="fu">paste</span>(string_list_in, <span class="at">collapse=</span><span class="st">", "</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  string_list <span class="ot">=</span> <span class="fu">strsplit</span>(string, <span class="st">' '</span>)[[<span class="dv">1</span>]]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  final_string <span class="ot">=</span> <span class="st">'</span><span class="sc">\n\t</span><span class="st">'</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  tmp_line <span class="ot">=</span> <span class="st">''</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(string_list)) {</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (s <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      tmp_string <span class="ot">=</span> string_list[s]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      tmp_string <span class="ot">=</span> <span class="fu">paste</span>(tmp_line, string_list[s])</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nchar</span>(tmp_string) <span class="sc">&lt;=</span> b) {</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      tmp_line <span class="ot">=</span> tmp_string</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>  <span class="cf">if</span> (<span class="fu">nchar</span>(tmp_string) <span class="sc">&gt;</span> b) {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      final_string <span class="ot">=</span> <span class="fu">paste0</span>(final_string, tmp_line, <span class="st">"</span><span class="sc">\n\t</span><span class="st">"</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      tmp_line <span class="ot">=</span> string_list[s]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (s <span class="sc">==</span> <span class="fu">length</span>(string_list)) {</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>      final_string <span class="ot">=</span> <span class="fu">paste0</span>(final_string, tmp_line, <span class="st">"</span><span class="sc">\n\t</span><span class="st">"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final_string)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dtm <span class="ot">=</span> <span class="fu">create_dtm</span>(itokens, <span class="fu">vocab_vectorizer</span>(vocab))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>tfidf <span class="ot">=</span> TfIdf<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>dtm <span class="ot">=</span> <span class="fu">fit_transform</span>(dtm, tfidf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is the size of the vocabulary in <code>dtm</code> and some example terms.</p>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"vocab size: "</span>, <span class="fu">length</span>(<span class="fu">colnames</span>(dtm))))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">example words: "</span>, <span class="fu">cat_string</span>(<span class="fu">colnames</span>(dtm)[<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>vocab size: 31590
example words:  
    4_or, about_man_who, about_most, absolutely_nothing_to_do, accordingly,
    acted_well, acting_plot, actually_make, after_many, again_by, again_would,
    all_i'm, all_quite, already_mentioned, although_i'm, antics_of, any_of_those,
    applauded, around_same, as_powerful, at_acting, at_all_there, at_core,
    at_heart_of, be_boring
    </code></pre>
</div>
</div>
</section>
<section id="building-a-vocabulary-for-interpretation" class="level2">
<h2 class="anchored" data-anchor-id="building-a-vocabulary-for-interpretation">Building a Vocabulary for Interpretation</h2>
<p>The goal is to select a smaller vocabulary set under a target size <span class="math inline">\(N_t\)</span> that contains highly interpretive terms. Such terms would intuitively signal positive or negative sentiment to a human reader. For instance, the terms “bad”, “worst”, “terrible” are clearly negative. Alternatively, the words “acting”, “core”, “same” are not clearly positive or negative. Of course, the terms would also need to be useful for predictions, so the process of selecting this vocabulary set is carried out in multiple steps. Note that the selected vocabulary set is extracted from the entire data to reduce computational expense. This may not be considered the most appropriate approach but it is as an extension of the tokenization, pruning, and normalization preprocesses. The vocabulary selection is essentially a dimensional reduction method.</p>
<p>The DTM matrix is fitted by a LASSO Logistic Regression model to select terms that are informative towards predicting sentiment of reviews. The motivation is to continue shrinking the vocabulary to keep the most informative terms for eventual predictions. A simple screening method is used to shrink the <span class="math inline">\(20,000+\)</span> vocabulary to some target size <span class="math inline">\(N_t\)</span>. The <span class="math inline">\(10,000\)</span> most informative terms are selected from the LASSO model shown below using its degrees of freedom for different <span class="math inline">\(\lambda\)</span> values.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>data_classifier1 <span class="ot">=</span> <span class="fu">glmnet</span>(<span class="at">x =</span> dtm, </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">y =</span> data<span class="sc">$</span>sentiment, </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">family=</span><span class="st">'binomial'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is a helper function to ensure DTM matrices are compatible with a given vocabulary set. This is useful for updating DTM matrices as the vocabulary shrinks, but also for making train-test matrices compatible with each other during model training and evaluation steps.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>columnConform <span class="ot">=</span> <span class="cf">function</span>(data_matrix, column_names) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  coverage <span class="ot">=</span> <span class="fu">colnames</span>(data_matrix) <span class="sc">%in%</span> column_names</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  miss <span class="ot">=</span> <span class="sc">!</span>(column_names <span class="sc">%in%</span> <span class="fu">colnames</span>(data_matrix))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  new_data <span class="ot">=</span> data_matrix[, coverage]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  empty_data <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(new_data), <span class="fu">sum</span>(miss))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(empty_data) <span class="ot">=</span> column_names[miss]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  new_data <span class="ot">=</span> <span class="fu">as.matrix</span>(<span class="fu">cbind</span>(new_data, empty_data))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  new_data <span class="ot">=</span> new_data[, column_names]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(new_data)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here the vocabulary is reduced by the LASSO model <code>data_classifier1</code> to size <span class="math inline">\(N \leq 10,000\)</span>.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># target size is 10000</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># select vocabulary set within target size</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>below_target <span class="ot">=</span> data_classifier1<span class="sc">$</span>df[data_classifier1<span class="sc">$</span>df <span class="sc">&lt;=</span> <span class="dv">10000</span>]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>df_max_vocab <span class="ot">=</span> data_classifier1<span class="sc">$</span>df[<span class="fu">which.max</span>(below_target)]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>df_index <span class="ot">=</span> <span class="fu">which</span>(data_classifier1<span class="sc">$</span>df <span class="sc">==</span> df_max_vocab)[<span class="dv">1</span>]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 10,000 terms vocabulary</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>vocab_lasso <span class="ot">=</span> <span class="fu">colnames</span>(dtm)[<span class="fu">which</span>(data_classifier1<span class="sc">$</span>beta[, df_index] <span class="sc">!=</span> <span class="dv">0</span>)]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># update dtm matrix</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>dtm <span class="ot">=</span> <span class="fu">columnConform</span>(dtm, vocab_lasso)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>vocab_size <span class="ot">=</span> <span class="fu">dim</span>(dtm)[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is the size of the vocabulary <code>vocab_lasso</code> and some example terms.</p>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"vocab size: "</span>, vocab_size))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">example words: "</span>, <span class="fu">cat_string</span>(vocab_lasso[<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>vocab size: 9918
example words:  
    actually_make, again_by, although_i'm, any_of_those, applauded, at_acting,
    at_all_there, be_boring, better_not, but_in_opinion, can_call_that, can_read,
    careless, cast_which, contrasts, development_in, don't_be_fooled_by,
    don't_know_but, download, dvd_from, early_90s, entire_story, etc_in,
    film_that_could, for_own_good
    </code></pre>
</div>
</div>
<p>So far the vocabulary is more than sufficient for predictive purposes, but not quite for interpretation. So, less interpretive terms are filtered out using a marginal two-sample t-test. The <code>slam</code> package is used to process the large and sparse DTM matrix efficiently. All terms are ordered by the magnitude of their respective t-statistics. The top <span class="math inline">\(2,000\)</span> terms are selected from the ordered vocabulary as they are the most interpretive terms. A few terms appeared exclusively in reviews that were either positive or negative, but were filtered out by the t-test. So, they are added back in since they may be useful for interpretation.</p>
<p>Here the t-test statistics are computed for each term in the DTM matrix.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>summ <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span>vocab_size, <span class="at">ncol=</span><span class="dv">4</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and variances of terms associated with positive reviews</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>summ[,<span class="dv">1</span>] <span class="ot">=</span> <span class="fu">colapply_simple_triplet_matrix</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.simple_triplet_matrix</span>( dtm[ data<span class="sc">$</span>sentiment<span class="sc">==</span><span class="dv">1</span>, ] ), mean)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>summ[,<span class="dv">2</span>] <span class="ot">=</span> <span class="fu">colapply_simple_triplet_matrix</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.simple_triplet_matrix</span>( dtm[ data<span class="sc">$</span>sentiment<span class="sc">==</span><span class="dv">1</span>, ] ), var)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and variances of terms associated with negative reviews</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>summ[,<span class="dv">3</span>] <span class="ot">=</span> <span class="fu">colapply_simple_triplet_matrix</span>(</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.simple_triplet_matrix</span>( dtm[ data<span class="sc">$</span>sentiment<span class="sc">==</span><span class="dv">0</span>, ] ), mean)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>summ[,<span class="dv">4</span>] <span class="ot">=</span> <span class="fu">colapply_simple_triplet_matrix</span>(</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.simple_triplet_matrix</span>( dtm[ data<span class="sc">$</span>sentiment<span class="sc">==</span><span class="dv">0</span>, ] ), var)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># number of positive and negative reviews</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>n1 <span class="ot">=</span> <span class="fu">sum</span>(data<span class="sc">$</span>sentiment)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">length</span>(data<span class="sc">$</span>sentiment)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>n0 <span class="ot">=</span> n <span class="sc">-</span> n1</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># t-statistics for each term</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>tstats <span class="ot">=</span> (summ[,<span class="dv">1</span>] <span class="sc">-</span> summ[,<span class="dv">3</span>]) <span class="sc">/</span> <span class="fu">sqrt</span>(summ[,<span class="dv">2</span>]<span class="sc">/</span>n1 <span class="sc">+</span> summ[,<span class="dv">4</span>]<span class="sc">/</span>n0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here the <span class="math inline">\(10,000\)</span> term vocabulary is filtered by the two-sample t-test and reduced to size <span class="math inline">\(N \leq 2,000\)</span>.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># target size is 2000</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># select most interpretive words</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>words <span class="ot">=</span> <span class="fu">colnames</span>(dtm)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>id <span class="ot">=</span> <span class="fu">order</span>(<span class="fu">abs</span>(tstats), <span class="at">decreasing=</span><span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">2000</span>, <span class="fu">dim</span>(dtm)[<span class="dv">2</span>])]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># positive and negative words</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>pos_vocab <span class="ot">=</span> words[ id[ tstats[id] <span class="sc">&gt;</span> <span class="dv">0</span> ] ]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>neg_vocab <span class="ot">=</span> words[ id[ tstats[id] <span class="sc">&lt;</span> <span class="dv">0</span> ] ]</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># checks for terms that appear in only one sentiment</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>id1 <span class="ot">=</span> <span class="fu">which</span>(summ[, <span class="dv">2</span>] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>id0 <span class="ot">=</span> <span class="fu">which</span>(summ[, <span class="dv">4</span>] <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co"># new vocabulary with ~2000 words</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>vocab_ttest <span class="ot">=</span> words[<span class="fu">union</span>(<span class="fu">union</span>(id, id1), id0)]</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co"># update the dtm matrix to the new vocabulary</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>dtm <span class="ot">=</span> <span class="fu">columnConform</span>(dtm, vocab_ttest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is the size of the vocabulary <code>vocab_ttest</code> and some example terms. Sets for positive and negative sentiments from the vocabulary are shown as well.</p>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"vocab size: "</span>, <span class="fu">length</span>(vocab_ttest)))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">example words: "</span>, <span class="fu">cat_string</span>(vocab_ttest[<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>])))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">positive vocab size: "</span>, <span class="fu">length</span>(pos_vocab)))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">example words: "</span>, <span class="fu">cat_string</span>(pos_vocab[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>])))</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">negative vocab size: "</span>, <span class="fu">length</span>(neg_vocab)))</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">example words: "</span>, <span class="fu">cat_string</span>(neg_vocab[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>vocab size: 2000
example words:  
    bad, worst, great, waste, awful, excellent, best, no, terrible, love, nothing,
    worse, boring, wonderful, even, of_best, stupid, of_worst, well, horrible,
    minutes, waste_of, poor, one_of_best, at_all
    
positive vocab size: 872
example words:  
    great, excellent, best, love, wonderful, of_best, well, one_of_best, perfect,
    also, amazing, loved, very, one_of, beautiful, highly, life, favorite, superb,
    brilliant, enjoyed, today, must_see, both, always, will, very_well, years,
    fantastic, world, still, heart, performance, performances, definitely, family,
    fun, especially, true, highly_recommend, classic, job, perfectly, 8, well_worth,
    touching, this_great, love_this, wonderfully, 10_10
    
negative vocab size: 1128
example words:  
    bad, worst, waste, awful, no, terrible, nothing, worse, boring, even, stupid,
    of_worst, horrible, minutes, waste_of, poor, at_all, crap, so_bad, money, plot,
    one_of_worst, supposed, just, avoid, script, ridiculous, why, not_even, poorly,
    acting, 1, only, lame, annoying, wasted, worst_movie, pathetic, pointless,
    instead, cheap, save, dull, oh, unless, any, don't, laughable, could, least
    </code></pre>
</div>
</div>
<p>After selecting the best <span class="math inline">\(\sim2000\)</span> terms from the LASSO model and the two-sample t-test, another LASSO model is refitted on the new DTM matrix to further reduce the size of the vocabulary within the final target size <span class="math inline">\(N_t\)</span>. Note that this step is identical to the previous LASSO model for terms selection, but with a smaller target size for vocabulary.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>data_classifier2 <span class="ot">=</span> <span class="fu">glmnet</span>(<span class="at">x =</span> dtm, </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">y =</span> data<span class="sc">$</span>sentiment, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">family=</span><span class="st">'binomial'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here the vocabulary is reduced by the LASSO model <code>data_classifier2</code> to size <span class="math inline">\(N \leq 1,000\)</span>, the final target size.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># target size is 1000</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>below_target <span class="ot">=</span> data_classifier2<span class="sc">$</span>df[data_classifier2<span class="sc">$</span>df <span class="sc">&lt;=</span> <span class="dv">1000</span>]</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>df_max_vocab <span class="ot">=</span> data_classifier2<span class="sc">$</span>df[<span class="fu">which.max</span>(below_target)]</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>df_index <span class="ot">=</span> <span class="fu">which</span>(data_classifier2<span class="sc">$</span>df <span class="sc">==</span> df_max_vocab)[<span class="dv">1</span>]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>final_vocab <span class="ot">=</span> <span class="fu">colnames</span>(dtm)[<span class="fu">which</span>(data_classifier2<span class="sc">$</span>beta[, df_index] <span class="sc">!=</span> <span class="dv">0</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here is the size of the vocabulary <code>final_vocab</code> and some example terms.</p>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"final vocab size: "</span>, <span class="fu">length</span>(final_vocab)))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">example words: "</span>, <span class="fu">cat_string</span>(final_vocab[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>final vocab size: 994
example words:  
    bad, worst, great, waste, awful, excellent, best, no, terrible, love, nothing,
    worse, boring, wonderful, even, of_best, stupid, of_worst, well, horrible,
    minutes, poor, at_all, perfect, crap, so_bad, also, money, plot, amazing, loved,
    supposed, very, just, one_of, beautiful, avoid, script, ridiculous, why,
    not_even, highly, poorly, acting, life, favorite, superb, 1, only, lame,
    brilliant, annoying, wasted, pathetic, pointless, instead, enjoyed, cheap,
    today, must_see, save, dull, oh, both, always, unless, any, don't, will,
    laughable, very_well, could, years, least, fantastic, 2, badly, world, or,
    fails, still, couldn't, heart, mess, make, performance, performances, to_make,
    definitely, how_bad, garbage, reason, to_be, family, attempt, redeeming,
    avoid_this, fun, especially, anything
    </code></pre>
</div>
</div>
</section>
<section id="model-training" class="level2">
<h2 class="anchored" data-anchor-id="model-training">Model Training</h2>
<p>First, the train and test data are split from the full data. The datasets undergo the same preprocessing procedure as shown previously, up to TF-IDF transformation. The helper function <code>preprocessDTM</code> is defined in the hidden code block below, and <code>columnConform</code> is defined in the previous section.</p>
<div class="cell">
<details>
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># preprocess function to create DTM matrices as shown earlier in the notebook</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>preprocessDTM <span class="ot">=</span> <span class="cf">function</span>(data, text_column) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove HTML tags</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  data[[text_column]] <span class="ot">=</span> <span class="fu">gsub</span>(<span class="st">'&lt;.*?&gt;'</span>, <span class="st">' '</span>, data[[text_column]])</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tokenize words in reviews</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  itokens <span class="ot">=</span> <span class="fu">itoken</span>(data[[text_column]], </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">preprocessor =</span> tolower, </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">tokenizer =</span> word_tokenizer)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># words ignored by the vocabulary</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  stop_words <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"i"</span>, <span class="st">"me"</span>, <span class="st">"my"</span>, <span class="st">"myself"</span>, <span class="st">"we"</span>, <span class="st">"our"</span>, <span class="st">"ours"</span>, <span class="st">"ourselves"</span>, </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"you"</span>, <span class="st">"your"</span>, <span class="st">"yours"</span>, <span class="st">"their"</span>, <span class="st">"they"</span>, <span class="st">"his"</span>, <span class="st">"her"</span>, </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"she"</span>, <span class="st">"he"</span>, <span class="st">"a"</span>, <span class="st">"an"</span>, <span class="st">"and"</span>, <span class="st">"is"</span>, <span class="st">"was"</span>, <span class="st">"are"</span>, <span class="st">"were"</span>, </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"him"</span>, <span class="st">"himself"</span>, <span class="st">"has"</span>, <span class="st">"have"</span>, <span class="st">"it"</span>, <span class="st">"its"</span>, <span class="st">"the"</span>, <span class="st">"us"</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  vocab <span class="ot">=</span> <span class="fu">create_vocabulary</span>(itokens, </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>                            <span class="at">stopwords =</span> stop_words, </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ngram =</span> <span class="fu">c</span>(1L, 4L)) <span class="co"># uses 1-4 n-grams </span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  vocab <span class="ot">=</span> <span class="fu">prune_vocabulary</span>(vocab, </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>                           <span class="at">term_count_min =</span> <span class="dv">10</span>, <span class="co"># ignores terms under 10 count</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>                           <span class="at">doc_proportion_max =</span> <span class="fl">0.5</span>, <span class="co"># ignores terms over 0.5 proportion</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>                           <span class="at">doc_proportion_min =</span> <span class="fl">0.001</span>) <span class="co"># ignores terms under 0.001 proportion</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  dtm <span class="ot">=</span> <span class="fu">create_dtm</span>(itokens, <span class="fu">vocab_vectorizer</span>(vocab))</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  tfidf <span class="ot">=</span> TfIdf<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>  dtm <span class="ot">=</span> <span class="fu">fit_transform</span>(dtm, tfidf)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dtm)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test ids for test-train split</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>test_id <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="fu">round</span>(<span class="fl">0.2</span> <span class="sc">*</span> <span class="fu">nrow</span>(data)))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># train and test data split from full data</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>train <span class="ot">=</span> data[<span class="sc">-</span>test_id, ]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>test <span class="ot">=</span> data[test_id, ]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># preprocess train data</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>dtm_train <span class="ot">=</span> <span class="fu">preprocessDTM</span>(train, <span class="st">"review"</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>dtm_train <span class="ot">=</span> <span class="fu">columnConform</span>(dtm_train, final_vocab)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co"># preprocess test data</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>dtm_test <span class="ot">=</span> <span class="fu">preprocessDTM</span>(test, <span class="st">"review"</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>dtm_test <span class="ot">=</span> <span class="fu">columnConform</span>(dtm_test, final_vocab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The train DTM matrix is fitted with a Cross-Validated Ridge Logistic Regression model. The following hyperparameters are used (strict convergence hyperparameters are unnecessary for sufficient model performance, likely due to vocabulary selection procedure):</p>
<ul>
<li><strong>Number of cross-validation folds</strong>: <code>5</code></li>
<li><strong>Convergence threshold</strong>: <code>1e-5</code></li>
<li><strong>Maximum iterations</strong>: <code>1e3</code></li>
</ul>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># training the ridge logistic regression model</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>train_classifier <span class="ot">=</span> <span class="fu">cv.glmnet</span>(<span class="at">x =</span> dtm_train, <span class="at">y =</span> train<span class="sc">$</span>sentiment, </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">family=</span><span class="st">'binomial'</span>, <span class="at">alpha =</span> <span class="dv">0</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nfolds =</span> <span class="dv">5</span>, <span class="at">thresh =</span> <span class="fl">1e-5</span>, <span class="at">maxit =</span> <span class="fl">1e3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation">Model Evaluation</h2>
<p>Now the Ridge model is evaluated. It returns predicted probabilities that a review has a positive sentiment (i.e., <span class="math inline">\(1 - \hat{P}(positive)\)</span> is the predicted probability that a review is negative).</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test predictions for sentiment of reviews</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">predict</span>(train_classifier, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">s =</span> train_classifier<span class="sc">$</span>lambda.min, </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">newx =</span> <span class="fu">as.matrix</span>(dtm_test),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">type=</span><span class="st">'response'</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">cbind</span>(test<span class="sc">$</span>id, pred)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(pred) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"prob"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     id        prob
1 48443 0.999962504
2 24421 0.001634074
3 39808 0.991950504
4  5392 0.036798413
5 11464 0.124424832
6 24351 0.945534809</code></pre>
</div>
</div>
<div class="cell">

</div>
<p>The Ridge model has an Area Under the Receiver Operating Characteristic curve (AUROC) score of 0.9684. So, the model can correctly classify at least 96.84% of the reviews in the test data. Despite the sufficient performance of the model, the general procedure for vocabulary selection could be further improved towards interpretation. Possible next steps include removing redundant vocabulary terms, adding topic models to enrich representation of terms with ambiguous meanings, or adding neural networks to generalize contexts better. In any case, this procedure demonstrates that interpretive terms can be extracted for highly accurate text classification tasks.</p>
<div class="cell">
<details open="">
<summary>Reveal the code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># merge predicted probabilities with actual sentiment scores</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">=</span> <span class="fu">merge</span>(pred, test, <span class="at">by=</span><span class="st">"id"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># roc object for evaluation</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>roc_obj <span class="ot">=</span> <span class="fu">roc</span>(pred<span class="sc">$</span>sentiment, pred<span class="sc">$</span>prob)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>auc_result <span class="ot">=</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># roc curve and auc score</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(roc_obj, <span class="at">print.auc=</span><span class="cn">TRUE</span>, <span class="at">print.thres=</span><span class="cn">TRUE</span>, </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">max.auc.polygon=</span><span class="cn">TRUE</span>, <span class="at">auc.polygon=</span><span class="cn">TRUE</span>, <span class="at">auc.polygon.col =</span> <span class="st">"lightblue"</span>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">smooth</span>(roc_obj), <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">"red"</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">"Empirical"</span>, <span class="st">"Smoothed"</span>),</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>), <span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="text_classification_interpretation_files/figure-html/model%20evaluations-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>